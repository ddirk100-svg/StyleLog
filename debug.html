<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RLS ë””ë²„ê·¸</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #fff;
        }
        .section {
            background: #2d2d2d;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        h2 {
            color: #4ec9b0;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #dcdcaa; }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1177bb;
        }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” StyleLog RLS ë””ë²„ê·¸</h1>
    
    <div class="section">
        <h2>1. í˜„ì¬ ë¡œê·¸ì¸ ìƒíƒœ</h2>
        <button onclick="checkAuth()">í™•ì¸</button>
        <pre id="authStatus">ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</pre>
    </div>

    <div class="section">
        <h2>2. ëª¨ë“  ì¼ê¸° ëª©ë¡ (RLS ì ìš©ë¨)</h2>
        <button onclick="checkLogs()">í™•ì¸</button>
        <pre id="logsStatus">ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</pre>
    </div>

    <div class="section">
        <h2>3. í…ŒìŠ¤íŠ¸ ì¼ê¸° ì‘ì„±</h2>
        <button onclick="createTestLog()">í…ŒìŠ¤íŠ¸ ì¼ê¸° ìƒì„±</button>
        <pre id="createStatus">ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</pre>
    </div>

    <div class="section">
        <h2>4. ë¬¸ì œ í•´ê²°</h2>
        <p class="warning">âš ï¸ ìœ„ì˜ ê²°ê³¼ë¥¼ í™•ì¸í•œ í›„ ë¬¸ì œê°€ ìˆìœ¼ë©´:</p>
        <ul>
            <li>ë¡œê·¸ì¸ ìƒíƒœê°€ NULLì´ë©´ â†’ ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”</li>
            <li>ì¼ê¸°ì— user_idê°€ ì—†ìœ¼ë©´ â†’ simple_setup.sqlì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”</li>
            <li>ë‹¤ë¥¸ ì‚¬ìš©ì ì¼ê¸°ê°€ ë³´ì´ë©´ â†’ RLSê°€ ì‘ë™í•˜ì§€ ì•ŠëŠ” ê²ƒì…ë‹ˆë‹¤</li>
        </ul>
        <button onclick="location.href='index.html'">í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="scripts/config.js"></script>
    <script src="scripts/api.js"></script>

    <script>
        async function checkAuth() {
            const output = document.getElementById('authStatus');
            output.textContent = 'í™•ì¸ ì¤‘...';
            
            try {
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                
                if (error) throw error;
                
                if (user) {
                    output.innerHTML = `
<span class="success">âœ… ë¡œê·¸ì¸ë¨</span>

ì´ë©”ì¼: ${user.email}
ì‚¬ìš©ì ID: ${user.id}
ê°€ì…ì¼: ${new Date(user.created_at).toLocaleString()}
                    `.trim();
                } else {
                    output.innerHTML = `<span class="error">âŒ ë¡œê·¸ì¸ ì•ˆë¨</span>\n\në¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!`;
                }
            } catch (error) {
                output.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜</span>\n\n${error.message}`;
            }
        }

        async function checkLogs() {
            const output = document.getElementById('logsStatus');
            output.textContent = 'í™•ì¸ ì¤‘...';
            
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                const { data: logs, error } = await supabaseClient
                    .from('style_logs')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                if (!logs || logs.length === 0) {
                    output.innerHTML = `<span class="warning">ğŸ“­ ì¼ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤</span>\n\nìƒˆë¡œ ì‘ì„±í•´ë³´ì„¸ìš”!`;
                    return;
                }
                
                let result = `<span class="success">âœ… ${logs.length}ê°œì˜ ì¼ê¸° ë°œê²¬</span>\n\n`;
                
                logs.forEach((log, i) => {
                    const isMine = log.user_id === user?.id;
                    const icon = isMine ? 'âœ…' : 'âŒ';
                    const status = log.user_id ? (isMine ? 'ë‚´ ì¼ê¸°' : 'ë‹¤ë¥¸ ì‚¬ëŒ ì¼ê¸°') : 'user_id ì—†ìŒ';
                    
                    result += `${i + 1}. [${icon}] ${log.date} - ${log.title || 'ì œëª©ì—†ìŒ'}\n`;
                    result += `   user_id: ${log.user_id || 'NULL'} (${status})\n\n`;
                });
                
                // ë‹¤ë¥¸ ì‚¬ëŒ ì¼ê¸°ê°€ ë³´ì´ë©´ ê²½ê³ 
                const otherLogs = logs.filter(log => log.user_id && log.user_id !== user?.id);
                if (otherLogs.length > 0) {
                    result += `\n<span class="error">âš ï¸ ê²½ê³ : ë‹¤ë¥¸ ì‚¬ìš©ì ì¼ê¸° ${otherLogs.length}ê°œê°€ ë³´ì…ë‹ˆë‹¤!</span>\n`;
                    result += `RLSê°€ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•Šê³  ìˆìŠµë‹ˆë‹¤.\n`;
                    result += `simple_setup.sqlì„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.`;
                }
                
                output.innerHTML = result;
            } catch (error) {
                output.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜</span>\n\n${error.message}`;
            }
        }

        async function createTestLog() {
            const output = document.getElementById('createStatus');
            output.textContent = 'ìƒì„± ì¤‘...';
            
            try {
                const testLog = {
                    date: new Date().toISOString().split('T')[0],
                    title: 'í…ŒìŠ¤íŠ¸ ì¼ê¸° - ' + new Date().toLocaleTimeString(),
                    content: 'ì´ê²ƒì€ RLS í…ŒìŠ¤íŠ¸ìš© ì¼ê¸°ì…ë‹ˆë‹¤.',
                    weather: 'sunny',
                    weather_temp: 20,
                    weather_temp_min: 15,
                    weather_temp_max: 25,
                    tags: ['í…ŒìŠ¤íŠ¸'],
                    photos: [],
                    is_favorite: false
                };
                
                const result = await StyleLogAPI.create(testLog);
                
                output.innerHTML = `
<span class="success">âœ… ìƒì„± ì™„ë£Œ!</span>

ì œëª©: ${result.title}
ë‚ ì§œ: ${result.date}
user_id: ${result.user_id || 'NULL'}

${result.user_id ? 'âœ… user_idê°€ ìë™ìœ¼ë¡œ ë“¤ì–´ê°”ìŠµë‹ˆë‹¤!' : 'âŒ user_idê°€ ì—†ìŠµë‹ˆë‹¤. API ì½”ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.'}
                `.trim();
            } catch (error) {
                output.innerHTML = `<span class="error">âŒ ì˜¤ë¥˜</span>\n\n${error.message}`;
                console.error('ìƒì„¸ ì˜¤ë¥˜:', error);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ í™•ì¸
        window.addEventListener('load', () => {
            checkAuth();
        });
    </script>
</body>
</html>


