<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4JCJ9BQ674"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-4JCJ9BQ674');
    </script>
    <link rel="icon" href="img/StyleLog_logo(favicon).png" type="image/png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤íƒ€ì¼ë¡œê·¸ - íšŒì›ê°€ì…</title>
    <link rel="stylesheet" href="styles/auth.css">
    <!-- Supabase í´ë¼ì´ì–¸íŠ¸ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- ì„¤ì • -->
    <script src="scripts/config.js"></script>
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <!-- ë¡œê³  -->
            <div class="auth-logo">
                <h1>StyleLog</h1>
                <p>ì˜¤ëŠ˜ ë­ì…ì§€?</p>
            </div>

            <!-- íšŒì›ê°€ì… í¼ -->
            <form id="signupForm" class="auth-form">
                <div class="form-group">
                    <label for="email">ì´ë©”ì¼</label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        placeholder="example@email.com"
                        required
                        autocomplete="email">
                </div>

                <div class="form-group">
                    <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                    <input 
                        type="password" 
                        id="password" 
                        name="password" 
                        placeholder="6ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”"
                        required
                        autocomplete="new-password"
                        minlength="6">
                </div>

                <div class="form-group">
                    <label for="passwordConfirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                    <input 
                        type="password" 
                        id="passwordConfirm" 
                        name="passwordConfirm" 
                        placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                        required
                        autocomplete="new-password"
                        minlength="6">
                </div>

                <button type="submit" class="auth-btn primary" id="signupBtn">
                    íšŒì›ê°€ì…
                </button>

                <div class="auth-divider">
                    <span>ë˜ëŠ”</span>
                </div>

                <button type="button" class="auth-btn secondary" onclick="location.href='login.html'">
                    ë¡œê·¸ì¸
                </button>
            </form>

            <!-- ì—ëŸ¬/ì„±ê³µ ë©”ì‹œì§€ -->
            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>
        </div>
    </div>

    <script src="scripts/auth.js"></script>
    <script>
        // ì´ë¯¸ ë¡œê·¸ì¸ëœ ê²½ìš° í™ˆìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        window.addEventListener('load', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) {
                window.location.href = 'home.html';
            }
        });

        // íšŒì›ê°€ì… í¼ ì œì¶œ
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const emailInput = document.getElementById('email').value;
            const email = emailInput.toLowerCase().trim(); // ì´ë©”ì¼ ì •ê·œí™” (ì „ì²´ ì£¼ì†Œ)
            const password = document.getElementById('password').value;
            const passwordConfirm = document.getElementById('passwordConfirm').value;
            const signupBtn = document.getElementById('signupBtn');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            
            console.log('ğŸ“ íšŒì›ê°€ì… ì‹œë„:', email);
            
            // ì´ˆê¸°í™”
            errorMessage.textContent = '';
            successMessage.textContent = '';
            
            // ì´ë©”ì¼ í˜•ì‹ ì²´í¬
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                errorMessage.textContent = 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }
            
            // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
            if (password !== passwordConfirm) {
                errorMessage.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                return;
            }
            
            // ë¹„ë°€ë²ˆí˜¸ ê¸¸ì´ í™•ì¸
            if (password.length < 6) {
                errorMessage.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                return;
            }
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            signupBtn.disabled = true;
            signupBtn.textContent = 'ê°€ì… ì¤‘...';
            
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email, // ì •ê·œí™”ëœ ì „ì²´ ì´ë©”ì¼ ì£¼ì†Œ
                    password: password,
                    options: {
                        emailRedirectTo: window.location.origin + '/login.html'
                    }
                });
                
                // ë””ë²„ê¹…: ì‘ë‹µ ì „ì²´ í™•ì¸
                console.log('ğŸ” Supabase ì‘ë‹µ:', { data, error });
                
                if (error) {
                    console.error('âŒ ì—ëŸ¬ ë°œìƒ:', error);
                    throw error;
                }
                
                // ì¤‘ë³µ ì²´í¬: data.userê°€ ìˆì§€ë§Œ identitiesê°€ ë¹„ì–´ìˆìœ¼ë©´ ì¤‘ë³µ
                if (data.user && (!data.user.identities || data.user.identities.length === 0)) {
                    console.log('âŒ ì¤‘ë³µëœ ì´ë©”ì¼ (identities ì—†ìŒ)');
                    throw new Error('User already registered');
                }
                
                console.log('âœ… íšŒì›ê°€ì… ì„±ê³µ:', data);
                console.log('ğŸ“§ ê°€ì…ëœ ì´ë©”ì¼:', email);
                if (typeof gtag === 'function') gtag('event', 'sign_up');

                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ (ì´ë©”ì¼ ì¸ì¦ ì•ˆë‚´ í¬í•¨)
                successMessage.innerHTML = `
                    <strong>íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰</strong><br>
                    <br>
                    <strong style="color: #d32f2f;">âš ï¸ ì¤‘ìš”: ì´ë©”ì¼ ì¸ì¦ í•„ìš”</strong><br>
                    <strong>${email}</strong> ë©”ì¼í•¨ì„ í™•ì¸í•˜ì—¬<br>
                    ì¸ì¦ ë§í¬ë¥¼ í´ë¦­í•´ì£¼ì„¸ìš”.<br>
                    <br>
                    <small style="color: #666;">ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì•¼ ë¡œê·¸ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small><br>
                    <small style="color: #999;">3ì´ˆ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...</small>
                `;
                successMessage.style.lineHeight = '1.6';
                
                // 3ì´ˆ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
                
            } catch (error) {
                console.error('âŒ íšŒì›ê°€ì… ì˜¤ë¥˜:', error);
                console.error('ì—ëŸ¬ íƒ€ì…:', typeof error);
                console.error('ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
                console.error('ì—ëŸ¬ ê°ì²´:', JSON.stringify(error, null, 2));
                
                // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                if (error.message.includes('User already registered') || 
                    error.message.includes('already been registered') ||
                    error.message.includes('duplicate') ||
                    error.message.includes('already exists')) {
                    errorMessage.innerHTML = `
                        <strong>âš ï¸ ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ì…ë‹ˆë‹¤</strong><br>
                        <strong>${email}</strong>ì€(ëŠ”) ì´ë¯¸ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.<br>
                        <small>ë‹¤ë¥¸ ì´ë©”ì¼ì„ ì‚¬ìš©í•˜ê±°ë‚˜ <a href="login.html" style="color: #667eea; text-decoration: underline;">ë¡œê·¸ì¸</a>í•˜ì„¸ìš”.</small>
                    `;
                    errorMessage.style.lineHeight = '1.6';
                } else if (error.message.includes('Password should be at least 6 characters')) {
                    errorMessage.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                } else if (error.message.includes('Invalid email')) {
                    errorMessage.textContent = 'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                } else {
                    errorMessage.innerHTML = `
                        íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>
                        <small style="color: #999;">${error.message}</small><br>
                        <small style="color: #999;">ì½˜ì†”ì„ í™•ì¸í•˜ì—¬ ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</small>
                    `;
                }
                
                // ë²„íŠ¼ í™œì„±í™”
                signupBtn.disabled = false;
                signupBtn.textContent = 'íšŒì›ê°€ì…';
            }
        });
    </script>
</body>
</html>

